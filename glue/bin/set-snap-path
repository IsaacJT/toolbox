#!/bin/bash
if [ -z "${1}" ]; then
    echo "Pass snap name!!!"
    exit
fi

[ -z "${ARCH_TRIPLET}" ] && ARCH_TRIPLET="$(basename $(ls -d /usr/lib/*-linux-*))"

SNAP_PATH="/snap/${1}/current"

echo -e "\n# Update ~/.bashrc with follwing lines" >&2
echo "# start of modifications done by toolbox snap"
echo "SNAP_PATH=\"${SNAP_PATH}\""
echo "SNAP_TOOLBOX=\${SNAP_PATH}"
echo "alias sudo='sudo env "PATH=\$PATH" LD_LIBRARY_PATH=\$LD_LIBRARY_PATH'"
echo "XDG_DATA_DIRS=/usr/local/share:/usr/share:/snap/snapd/current/usr/share:\${SNAP_PATH}/usr/share"
echo "source ${SNAP_PATH}/etc/profile.d/bash_completion.sh"
echo "source ${SNAP_PATH}/bin/snapcraft-lxd-wrapper"
echo "# end of modifications done by toolbox snap"

# check if we need to update global environment
if [ -z "$(grep toolbox /etc/environment)" ] ; then
    source /etc/environment

    cat > /home/${USER}/environment << EOL
PATH="${SNAP_PATH}/bin:${SNAP_PATH}/sbin:${SNAP_PATH}/usr/bin:${SNAP_PATH}/usr/sbin:$PATH"
LD_LIBRARY_PATH="${SNAP_LIBRARY_PATH}:${SNAP_PATH}/lib:${SNAP_PATH}/usr/lib:${SNAP_PATH}/lib/${ARCH_TRIPLET}:${SNAP_PATH}/usr/lib/${ARCH_TRIPLET}"
EOL

    echo -e "run: sudo cp ${PWD}/environment /writable/system-data/etc/environment" >&2
fi
